<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>COPTOTHON 2025 — Live Dashboard</title>
<style>
:root{--bg:#f6fbff;--card:#fff;--accent:#00497a;--muted:#6b7280}
body{font-family:Inter,Segoe UI,Arial;background:var(--bg);margin:0;color:#042a3a}
.header{background:linear-gradient(90deg,var(--accent),#00a6c2);color:#fff;padding:18px;text-align:center}
.container{max-width:1100px;margin:18px auto;padding:12px}
nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:12px 0}
.btn{padding:8px 14px;border-radius:8px;border:none;background:#e7f3fb;cursor:pointer;font-weight:700}
.btn.active{background:var(--accent);color:#fff}
.card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 8px 22px rgba(2,6,23,0.06);margin-bottom:12px}
.grid{display:grid;grid-template-columns:1fr 340px;gap:14px}
input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #d7eaf2;margin:6px 0}
.submit{background:var(--accent);color:#fff;padding:10px;border:none;border-radius:8px;cursor:pointer}
.small{color:var(--muted);font-size:13px}
.hidden{display:none}
.adminOnly{display:none}
body.admin .adminOnly{display:block}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eef7fb;text-align:left}
th{background:#f0fbff}
.footer{text-align:center;color:var(--muted);font-size:13px;margin-top:12px}
.partList{max-height:300px;overflow:auto}
</style>
</head>
<body>
  <div class="header">
    <h1>COPTOTHON 2025 — Drone Design & Competition</h1>
    <div class="small">Admin: sarathkumar.j@klu.ac.in</div>
  </div>

  <div class="container">
    <nav id="menu">
      <button class="btn active" data-tab="home">Home</button>
      <button class="btn" data-tab="register">Register</button>
      <button class="btn" data-tab="checkin">QR Check-in</button>
      <button class="btn" data-tab="leader">Leaderboard</button>
      <button class="btn" data-tab="schedule">Schedule</button>
      <button class="btn" data-tab="participants">Participants</button>
      <button class="btn adminOnly" data-tab="admin">Admin Panel</button>
    </nav>

    <div class="grid">
      <div>

        <!-- HOME -->
<section id="home" class="card">
  <h2>Welcome to COPTOTHON 2025</h2>
  <p class="small">
    Welcome to <b>COPTOTHON 2025 – Drone Design & Competition</b> organized by the
    <b>Centre of Excellence (Drone Technology), Dept. of Aeronautical Engineering, SMACE, KARE</b>.
  </p>

  <p>
    Use this dashboard to <b>register, check-in, and view results</b>. 
    Participants can register once. Admin control is securely handled server-side.
  </p>

  <div class="card" style="background:#f7fbff;margin-top:12px;">
    <h3>Competition User Manual</h3>
    <p><b>Rounds Overview</b></p>
    <ul>
      <li><b>Round 1 – Presentation Round</b>: Team will present their drone design and explain its uniqueness, innovation, and functionality.</li>
      <li><b>Round 2 – Assembly & Preliminary Flight Test</b>: Teams will assemble and test their drone within a guided rope pathway to demonstrate control and stability.</li>
      <li><b>Round 3 – Final Flight Test</b>: Teams will perform free-flight tests without the guided path, showcasing full maneuverability and mission readiness.</li>
    </ul>

    <p><b>Materials Provided</b></p>
    <ul>
      <li>Micro drone components: Ice sticks, pencil motors, propellers, wires</li>
      <li>Provision for soldering, glue gun, and adhesives</li>
      <li>Workstation tools and safety materials</li>
    </ul>

    <p><b>Event Timeline</b></p>
    <ul>
      <li><b>Oct 29 & 30</b> – Pre-workshop & Training (5:00 PM to 7:00 PM)</li>
      <li><b>Oct 31 – Nov 1</b> – 30-hour Hackathon Challenge (Drone Build & Fly)</li>
    </ul>

    <p><b>Objectives</b></p>
    <ul>
      <li>Hands-on exposure in drone design, fabrication, and flight testing</li>
      <li>Integration of multidisciplinary engineering concepts</li>
      <li>Encouraging teamwork, innovation, and problem-solving</li>
    </ul>

    <p><b>Evaluation Criteria</b></p>
    <ul>
      <li>Drone Build & Technical Report – 30%</li>
      <li>Flight Performance in Missions – 40%</li>
      <li>Innovation & Design Approach – 20%</li>
      <li>Teamwork & Presentation – 10%</li>
    </ul>

    <p><b>Learning Outcomes</b></p>
    <ul>
      <li>Apply aerodynamics, propulsion, and control principles in drone design</li>
      <li>Demonstrate system integration and performance analysis</li>
      <li>Develop innovative drone configurations for mission profiles</li>
    </ul>
  </div>

  <div style="margin-top:16px;" class="small">
    <b>Rounds:</b> 1) Presentation Round &nbsp; 2) Assembly & Preliminary Flight Test &nbsp; 3) Final Flight Test
  </div>
</section>


        <!-- REGISTER -->
        <section id="register" class="card hidden">
          <h3>Register (Participants)</h3>
          <div class="small">Fill details once. Reg. No = your registration number (college reg no).</div>
          <input id="name" placeholder="Full name"/>
          <input id="email" placeholder="Email (optional)"/>
          <input id="phone" placeholder="Phone (WhatsApp)"/>
          <input id="dept" placeholder="Department"/>
          <input id="regno" placeholder="Reg. No. (Unique)"/>
          <input id="team" placeholder="Team name (choose your team)"/>
          <button class="submit" onclick="register()">Register</button>
          <div id="regNotice" class="small" style="margin-top:8px;color:green"></div>
        </section>

        <!-- CHECK-IN -->
        <section id="checkin" class="card hidden">
          <h3>QR Check-in</h3>
          <div class="small">Scan participant QR (or enter Reg. No) to mark presence.</div>
          <input id="checkRegNo" placeholder="Enter Reg. No to check-in"/>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="manualCheckIn()">Check-in by RegNo</button>
            <button class="btn" onclick="startCamera()">Start Camera (QR)</button>
          </div>
          <div id="cameraArea" class="small" style="margin-top:8px"></div>
          <div id="lastScan" class="small" style="margin-top:8px"></div>
        </section>

        <!-- LEADERBOARD -->
        <section id="leader" class="card hidden">
          <h3>Leaderboard</h3>
          <table id="leaderTable"><thead><tr><th>#</th><th>Name</th><th>Team</th><th>Reg. No.</th><th>Score</th></tr></thead><tbody></tbody></table>
          <div style="margin-top:8px" class="small">Scores come from judges entries (admin).</div>
        </section>

        <!-- SCHEDULE -->
        <section id="schedule" class="card hidden">
          <h3>Schedule</h3>
          <table id="sched"><thead><tr><th>Title</th><th>When</th><th>Notes</th><th class="adminOnly">Actions</th></tr></thead><tbody></tbody></table>

          <div class="adminOnly" style="margin-top:10px">
            <h4>Add Schedule</h4>
            <input id="sTitle" placeholder="Title"/>
            <input id="sWhen" placeholder="When"/>
            <input id="sNotes" placeholder="Notes"/>
            <button class="submit" onclick="addSchedule()">Add</button>
          </div>
        </section>

        <!-- PARTICIPANTS -->
        <section id="participants" class="card hidden">
          <h3>Registered Participants</h3>
          <div class="small">List updated live from Google Sheet</div>
          <div class="partList" id="partList"></div>
        </section>

        <!-- ADMIN PANEL -->
        <section id="admin" class="card adminOnly hidden">
          <h3>Admin Panel</h3>
          <div class="small">Admin functions: add/edit/delete schedule, announcements, manage scores, export data, clear all (careful).</div>

          <hr/>
          <h4>Announcements (Add / Edit / Delete)</h4>
          <input id="annTitle" placeholder="Title"/>
          <textarea id="annBody" placeholder="Message"></textarea>
          <button class="submit" onclick="announceAdd()">Post Announcement</button>
          <div id="annListAdmin" class="partList" style="margin-top:8px"></div>

          <hr/>
          <h4>Scores (Add)</h4>
          <div class="small">Add judge scores per participant and round</div>
          <select id="scoreParticipant"></select>
          <select id="scoreRound"><option value="1">Round 1 (Presentation)</option><option value="2">Round 2 (Assembly)</option><option value="3">Round 3 (Flight)</option></select>
          <input id="scoreJudge" placeholder="Judge name"/>
          <input id="scoreTotal" placeholder="Total score (numeric)"/>
          <input id="scoreDetails" placeholder="Details (optional)"/>
          <button class="submit" onclick="scoreAdd()">Add Score</button>

          <hr/>
          <h4>Danger Zone</h4>
          <button class="submit" style="background:#b81d13" onclick="clearAll()">Clear All Data</button>
        </section>

      </div>

      <!-- RIGHT COLUMN -->
      <div>
        <div class="card">
          <h4>Quick Info</h4>
          <div class="small">Event: COPTOTHON 2025</div>
          <div class="small">Rounds: Presentation, Assembly/Prelim Flight, Final Flight</div>
          <div style="margin-top:8px">
            <button class="btn" onclick="document.querySelector('[data-tab=register]').click()">Register Now</button>
            <button class="btn" onclick="document.querySelector('[data-tab=checkin]').click()">Start Check-in</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Export</h4>
          <button class="btn" onclick="exportParticipants()">Download Participants CSV</button>
          <button class="btn adminOnly" onclick="exportBackup()">Download Backup (JSON)</button>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Contact</h4>
          <div class="small">Dr. Sarathkumar Sebastin</div>
          <div class="small">sarathkumar.j@klu.ac.in</div>
          <div style="margin-top:6px"><a href="https://wa.me/917639972833?text=Hello%20COPTOTHON%20Organizer" target="_blank"><button class="btn">WhatsApp Organizer</button></a></div>
        </div>

      </div>
    </div>

    <div class="footer">© COPTOTHON 2025 • Dept. of Aeronautical Engineering</div>
  </div>

<script>
/* =========== CONFIG ============= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxe0DwGAedPz82zpaMjGKMmGgAyze4fxR9QUClRoyvd5-4nxGjoV5co-a4v24WfjocQZw/exec"; // <-- REPLACE with your Apps Script exec URL
const ADMIN_EMAIL = "sarathkumar.j@klu.ac.in";
let STATE = { email:"", isAdmin:false, data:{} };

/* =========== NAV =============== */
document.querySelectorAll('[data-tab]').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.getAttribute('data-tab');
    document.querySelectorAll('section').forEach(s=> s.classList.add('hidden'));
    const el = document.getElementById(tab);
    if(el) el.classList.remove('hidden');
  });
});

/* =========== API HELPERS ========= */
async function apiGet(){
  try{
    const r = await fetch(SCRIPT_URL);
    if(!r.ok) throw new Error("Network response not ok");
    return await r.json();
  }catch(e){
    console.error(e);
    alert("Error loading data. Check script URL & sheet deployment.");
    return null;
  }
}
async function apiPost(action, payload){
  try{
    const r = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({ action, payload })
    });
    return await r.json().catch(()=> ({ raw: "ok" }));
  }catch(e){
    console.error(e); alert("Write failed: "+e.message); return null;
  }
}

/* =========== RENDER ========= */
async function refresh(){
  const json = await apiGet();
  if(!json) return;
  STATE = json;
  // admin flag
  if(json.isAdmin) document.body.classList.add('admin'); else document.body.classList.remove('admin');

  // Participants list (bottom)
  renderParticipants(json.data.participants || []);

  // Leaderboard
  renderLeaderboard(json.data.participants || [], json.data.scores || []);

  // Schedule
  renderSchedule(json.data.schedule || []);

  // Announcements (for admin area)
  renderAdminAnnouncements(json.data.announcements || []);

  // fill select for scoring
  fillScoreParticipantSelect(json.data.participants || []);
}
function renderParticipants(arr){
  const el = document.getElementById('partList'); el.innerHTML = '';
  if(!arr || arr.length===0){ el.innerHTML = '<div class="small">No participants yet</div>'; return; }
  arr.slice().reverse().forEach(p=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid #eef7fb';
    div.innerHTML = `<b>${p.Name||p.Name}</b> <div class="small">${p.Department||''} • RegNo: ${p.RegNo||''} • Team: ${p.Team||''} • Score: ${p.Score||0}</div>`;
    el.appendChild(div);
  });
}
function renderLeaderboard(parts, scores){
  // compute total per participant by summing scores rows (server also updated Score in participants)
  const tbody = document.querySelector('#leaderTable tbody'); tbody.innerHTML = '';
  const rows = parts.map(p=> ({ id:p.id, Name:p.Name, Team:p.Team, RegNo:p.RegNo, Score: Number(p.Score||0) }));
  rows.sort((a,b)=>b.Score - a.Score);
  rows.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.Name||''}</td><td>${r.Team||''}</td><td>${r.RegNo||''}</td><td>${r.Score||0}</td>`;
    tbody.appendChild(tr);
  });
}
function renderSchedule(arr){
  const tbody = document.querySelector('#sched tbody'); tbody.innerHTML = '';
  arr.forEach(s=>{
    const row = document.createElement('tr');
    let actions = '';
    if(STATE.isAdmin) actions = `<td class="adminOnly"><button onclick="editSchedule('${s.id}')">Edit</button> <button onclick="deleteSchedule('${s.id}')">Delete</button></td>`; 
    row.innerHTML = `<td>${s.Title||''}</td><td>${s.When||''}</td><td>${s.Notes||''}</td>${actions}`;
    tbody.appendChild(row);
  });
}
function renderAdminAnnouncements(arr){
  const el = document.getElementById('annListAdmin'); el.innerHTML = '';
  arr.slice().reverse().forEach(a=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid #eef7fb';
    const btns = STATE.isAdmin ? `<div style="margin-top:6px"><button onclick="editAnn('${a.id}','${escapeHtml(a.Title||'')}','${escapeHtml(a.Body||'')}')">Edit</button> <button onclick="deleteAnn('${a.id}')">Delete</button></div>` : '';
    div.innerHTML = `<b>${a.Title||''}</b><div class="small">${a.Body||''}</div>${btns}`;
    el.appendChild(div);
  });
}
function fillScoreParticipantSelect(parts){
  const sel = document.getElementById('scoreParticipant'); sel.innerHTML = '';
  parts.forEach(p => {
    const opt = document.createElement('option'); opt.value = p.id; opt.text = `${p.Name} (${p.RegNo||''})`; sel.appendChild(opt);
  });
}

/* =========== ACTIONS ========== */
async function register(){
  // prevent double-register: localStorage check
  const regno = document.getElementById('regno').value.trim();
  if(!document.getElementById('name').value.trim()) return alert("Name required");
  // check server existing regno or email
  const parts = STATE.data.participants || [];
  if(regno && parts.find(x=> String(x.RegNo || '').trim() === regno.trim())) return alert("This Reg. No. is already registered.");
  const payload = {
    Name: document.getElementById('name').value.trim(),
    Email: document.getElementById('email').value.trim(),
    Phone: document.getElementById('phone').value.trim(),
    Department: document.getElementById('dept').value.trim(),
    RegNo: regno,
    Team: document.getElementById('team').value.trim()
  };
  const res = await apiPost('register', payload);
  if(res && res.status === "ok"){
    localStorage.setItem('coptothon_regid', res.id);
    document.getElementById('regNotice').innerText = "Registered successfully. Your ID: " + res.id;
    refresh();
  } else {
    alert("Register failed: " + (res && res.message ? res.message : "unknown"));
  }
}

async function manualCheckIn(){
  const reg = document.getElementById('checkRegNo').value.trim();
  if(!reg) return alert("Enter Reg. No.");
  const res = await apiPost('attendance', { RegNo: reg });
  if(res && res.status === "ok") {
    document.getElementById('lastScan').innerText = "Checked-in: " + reg;
    refresh();
  } else alert("Check-in failed: " + (res && res.message ? res.message : "unknown"));
}

/* camera scanning omitted for brevity (can be added later) */

/* admin: schedule */
async function addSchedule(){
  const payload = { title: document.getElementById('sTitle').value.trim(), when: document.getElementById('sWhen').value.trim(), notes: document.getElementById('sNotes').value.trim() };
  const res = await apiPost('schedule_add', payload);
  if(res && res.status === "ok") { alert("Added"); document.getElementById('sTitle').value='';document.getElementById('sWhen').value='';document.getElementById('sNotes').value=''; refresh(); }
  else alert("Failed");
}
async function editSchedule(id){ const newTitle = prompt("Title:"); if(newTitle===null) return; const when = prompt("When:"); await apiPost('schedule_edit',{id:id,title:newTitle,when:when||"",notes:""}); refresh(); }
async function deleteSchedule(id){ if(!confirm("Delete schedule?")) return; await apiPost('schedule_delete',{id:id}); refresh(); }

/* admin: announcements */
async function announceAdd(){
  const title = document.getElementById('annTitle').value.trim(), body = document.getElementById('annBody').value.trim();
  if(!title || !body) return alert("Title and body required");
  const res = await apiPost('announce_add', { title, body });
  if(res && res.status === "ok"){ document.getElementById('annTitle').value='';document.getElementById('annBody').value=''; refresh(); }
  else alert("Failed");
}
function editAnn(id, title, body){
  const t = prompt("Edit title:", unescapeHtml(title)); if(t===null) return;
  const b = prompt("Edit body:", unescapeHtml(body)); apiPost('announce_edit',{id:id,title:t,body:b}).then(()=>refresh());
}
async function deleteAnn(id){ if(!confirm("Delete announcement?")) return; await apiPost('announce_delete',{id:id}); refresh(); }

/* admin: scores */
async function scoreAdd(){
  const pid = document.getElementById('scoreParticipant').value;
  const round = document.getElementById('scoreRound').value;
  const judge = document.getElementById('scoreJudge').value.trim();
  const total = Number(document.getElementById('scoreTotal').value);
  const details = document.getElementById('scoreDetails').value.trim();
  if(!pid || !round || !judge || isNaN(total)) return alert("Fill all score fields");
  const res = await apiPost('score_add',{ participantId: pid, Round: round, Judge: judge, Total: total, Details: details });
  if(res && res.status === "ok") { alert("Score added"); refresh(); } else alert("Failed");
}

/* admin: clear all */
async function clearAll(){
  if(!confirm("This will clear ALL data. Continue?")) return;
  const res = await apiPost('clear_all', {});
  if(res && res.status === "ok") { alert("Cleared"); refresh(); } else alert("Failed");
}

/* exports */
function exportParticipants(){
  const rows = (STATE.data.participants||[]).map(p=> [p.Name||"", p.Email||"", p.Phone||"", p.Department||"", p.RegNo||"", p.Team||"", p.CheckIn||"", p.Score||"", p.CreatedAt||""]);
  const header = ["Name","Email","Phone","Department","RegNo","Team","CheckIn","Score","CreatedAt"];
  const csv = [header].concat(rows).map(r=> r.map(c=> `"${String(c||"").replace(/"/g,'""')}"`).join(",")).join("\n");
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = "participants.csv"; a.click();
}
function exportBackup(){
  const data = JSON.stringify(STATE.data, null, 2);
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download = "coptothon_backup.json"; a.click();
}

/* util */
function escapeHtml(s){ return String(s||'').replace(/'/g,"\\'").replace(/"/g,'\"'); }
function unescapeHtml(s){ return String(s||'').replace(/\\'/g,"'"); }

/* initial load */
refresh();
setInterval(refresh, 30000); // auto-refresh every 30s
</script>
</body>
</html>


