<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>COPTOTHON 2025 — Drone Dashboard</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f4fbff; --card:#ffffff; --muted:#6b7280; --accent:#0077d9; --accent2:#00c2d1;
    --glass: rgba(255,255,255,0.6);
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial;margin:0;background:linear-gradient(180deg,#eaf9ff 0%, #fbfcff 60%);color:#052034}
  .wrap{max-width:1200px;margin:18px auto;padding:18px}
  header{display:flex;align-items:center;gap:16px}
  .logo{width:84px;height:84px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:26px;box-shadow:0 10px 30px rgba(2,6,23,0.08)}
  h1{margin:0;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}
  .tab{padding:9px 14px;border-radius:10px;background:var(--card);border:1px solid rgba(2,6,23,0.04);cursor:pointer;font-weight:700;color:#052238;box-shadow:0 6px 18px rgba(10,25,41,0.03)}
  .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;border-color:transparent}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.06);border:1px solid rgba(2,6,23,0.04)}
  .row{display:flex;gap:8px;align-items:center}
  input,select,textarea,button{font-family:inherit}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6f0f8;background:transparent}
  textarea{min-height:80px}
  button{cursor:pointer;border-radius:10px;padding:10px 14px;border:none;background:var(--accent);color:white;font-weight:700}
  button.ghost{background:transparent;border:1px solid #dff3ff;color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #f1f8ff;font-size:13px}
  th{color:#052238;text-align:left}
  .list{max-height:360px;overflow:auto;display:flex;flex-direction:column;gap:8px}
  .item{padding:8px;border-radius:8px;border:1px solid #eef9ff;background:#fbfeff}
  .center{display:flex;align-items:center;justify-content:center}
  footer{font-size:12px;color:var(--muted);margin-top:18px;text-align:center}
  .qrCanvas{width:220px;height:220px;border-radius:10px;border:2px dashed #e6f6ff;background:white}
  .heroSVG{width:120px;height:120px}
  @media(max-width:980px){ .grid{grid-template-columns:1fr} .heroSVG{display:none} }
</style>

<!-- QR & scanner libs -->
<script src="https://unpkg.com/qrcode/build/qrcode.min.js"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">DT</div>
      <div>
        <h1>COPTOTHON 2025 — Drone Design & Competition</h1>
        <div class="muted">VINTRA • Dept. of Aeronautical Engineering · Admin: <b>sarathkumar.j@klu.ac.in</b></div>
      </div>
      <div style="margin-left:auto" class="row">
        <div class="small">Live: Google Sheets</div>
        <button id="adminLoginBtn" class="tab" style="margin-left:12px">Admin Login</button>
      </div>
    </header>

    <nav id="menu">
      <div class="tab active" data-tab="home">Home</div>
      <div class="tab" data-tab="register">Register</div>
      <div class="tab" data-tab="checkin">QR Check-in</div>
      <div class="tab" data-tab="leader">Leaderboard</div>
      <div class="tab" data-tab="schedule">Schedule</div>
      <div class="tab" data-tab="announce">Announcements</div>
      <div class="tab" data-tab="data">Data</div>
    </nav>

    <div class="grid">

      <!-- MAIN -->
      <div>

        <!-- HOME -->
        <section class="card" data-page="home" id="home">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2>Welcome to <span style="color:var(--accent)">COPTOTHON 2025</span></h2>
              <div class="small">Real-time dashboard backed by Google Sheets. Register, check-in, and follow live leaderboard.</div>
              <div style="margin-top:12px" class="row">
                <button id="openRegisterNow">Register</button>
                <button id="openCheckinNow" class="ghost">Start Check-in</button>
                <button id="openLeaderNow" class="ghost">Leaderboard</button>
              </div>
            </div>
            <div class="center">
              <!-- decorative drone SVG -->
              <svg class="heroSVG" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#0077d9"/><stop offset="1" stop-color="#00c2d1"/></linearGradient></defs>
                <g transform="translate(100,100) scale(0.9)">
                  <circle r="62" fill="url(#g1)" opacity="0.08"></circle>
                  <g>
                    <rect x="-46" y="-6" width="92" height="28" rx="8" fill="#fff" opacity="0.95"></rect>
                    <path d="M-86 -30 L-52 -4 L-86 22" fill="#0ea5e9" opacity="0.9"></path>
                    <circle cx="-86" cy="-30" r="10" fill="#0ea5e9" />
                    <circle cx="86" cy="-30" r="10" fill="#0ea5e9" />
                    <circle cx="-86" cy="46" r="10" fill="#0ea5e9" />
                    <circle cx="86" cy="46" r="10" fill="#0ea5e9" />
                  </g>
                </g>
              </svg>
            </div>
          </div>

          <hr/>
          <div class="row" style="gap:18px">
            <div style="flex:1">
              <div class="small">Event</div>
              <h3 id="evtTitle">COPTOTHON 2025 - Drone Competition</h3>
              <div class="small" id="evtDates">31 Oct - 01 Nov 2025 • Room 5003</div>
            </div>
            <div style="width:180px">
              <div class="small">Participants</div>
              <h2 id="statParticipants">0</h2>
              <div class="small">Checked-in: <span id="statChecked">0</span></div>
            </div>
          </div>
        </section>

        <!-- REGISTER -->
        <section class="card hidden" data-page="register" id="register">
          <h2>Student Registration</h2>
          <div class="small">Fill details and click Register — you will get a QR to save.</div>

          <div style="display:flex;gap:18px;margin-top:12px;align-items:flex-start">
            <div style="flex:1">
              <label class="small">Full name *</label>
              <input id="rName" placeholder="Full name" />
              <label class="small" style="margin-top:8px">Email</label>
              <input id="rEmail" placeholder="student@college.edu" />
              <label class="small" style="margin-top:8px">Phone (WhatsApp)</label>
              <input id="rPhone" placeholder="+91xxxxxxxxxx" />
              <label class="small" style="margin-top:8px">Department</label>
              <input id="rDept" placeholder="Dept. of Aeronautical Engineering" />
              <label class="small" style="margin-top:8px">Track</label>
              <input id="rTrack" placeholder="Frame / Avionics / Payload" />
              <div class="row" style="margin-top:12px">
                <button id="btnRegisterUser">Register & Get QR</button>
                <button id="btnDownloadQR" class="ghost">Download Last QR</button>
              </div>

              <hr style="margin-top:14px"/>
              <h4>Bulk Import (CSV)</h4>
              <div class="small">CSV: name,email,phone,department,track</div>
              <div style="margin-top:8px" class="row">
                <input type="file" id="csvInput" accept=".csv" />
                <button id="btnImportCSV" class="ghost">Import CSV</button>
              </div>
            </div>

            <div style="width:240px">
              <div class="small">QR Preview</div>
              <canvas id="qrCanvas" class="qrCanvas"></canvas>
              <div class="small" style="margin-top:8px">Save screenshot of the QR for check-in.</div>
            </div>
          </div>

          <hr/>
          <h3>Participants (latest)</h3>
          <div id="participantsList" class="list" style="margin-top:8px"></div>
        </section>

        <!-- CHECKIN -->
        <section class="card hidden" data-page="checkin" id="checkin">
          <h2>QR Check-in / Attendance</h2>
          <div class="small">Use camera to scan the QR code on student's phone.</div>

          <div style="margin-top:12px" class="row">
            <button id="startCamera">Start Camera</button>
            <button id="stopCamera" class="ghost">Stop</button>
            <button id="importScan" class="ghost">Scan Image</button>
            <input type="file" id="imgFile" accept="image/*" style="display:none"/>
            <div style="margin-left:auto">
              <button id="exportAttendance" class="ghost">Export Attendance CSV</button>
            </div>
          </div>

          <div style="margin-top:12px" class="row">
            <video id="video" autoplay playsinline style="width:360px;height:270px;border-radius:8px;background:#000"></video>
            <div style="flex:1">
              <div class="small">Last scanned</div>
              <div id="lastScanned" class="item">—</div>
              <h4 style="margin-top:12px">Present</h4>
              <div id="attendanceList" class="list"></div>
            </div>
          </div>
        </section>

        <!-- LEADERBOARD -->
        <section class="card hidden" data-page="leader" id="leader">
          <h2>Leaderboard</h2>
          <div class="small">Live scores (Sheet-driven)</div>
          <table id="leaderTable">
            <thead><tr><th>#</th><th>Name</th><th>Track</th><th>Score</th></tr></thead>
            <tbody></tbody>
          </table>
          <div style="margin-top:12px" class="row">
            <button id="refreshLeader" class="ghost">Refresh</button>
            <button id="exportScores" class="ghost">Export Scores CSV</button>
          </div>
        </section>

        <!-- SCHEDULE -->
        <section class="card hidden" data-page="schedule" id="schedule">
          <h2>Schedule</h2>
          <div class="small">Add/edit timetable (admin only in next step)</div>
          <div style="margin-top:10px" class="row">
            <input id="sTitle" placeholder="Activity title" />
            <input id="sWhen" placeholder="Time / slot" style="width:220px" />
            <button id="btnAddSchedule">Add</button>
          </div>
          <div id="scheduleList" class="list" style="margin-top:8px"></div>
        </section>

        <!-- ANNOUNCEMENTS -->
        <section class="card hidden" data-page="announce" id="announce">
          <h2>Announcements</h2>
          <div class="small">Post important notices (admin)</div>
          <div style="margin-top:10px">
            <input id="aTitle" placeholder="Title" />
            <textarea id="aBody" placeholder="Message"></textarea>
            <div class="row" style="margin-top:8px">
              <button id="btnPostAnn">Post Announcement</button>
              <label class="small" style="margin-left:auto"><input id="chkWhats" type="checkbox"> Prepare WhatsApp text</label>
            </div>
          </div>
          <div id="announcementsList" class="list" style="margin-top:12px"></div>
        </section>

        <!-- DATA -->
        <section class="card hidden" data-page="data" id="data">
          <h2>Data & Backups</h2>
          <div class="small">Download participant lists, attendance, or full backup.</div>
          <div style="margin-top:10px" class="row">
            <button id="downloadParticipants">Download participants CSV</button>
            <button id="downloadBackup" class="ghost">Download JSON Backup</button>
            <button id="clearAll" class="ghost" style="margin-left:auto">Reset (Admin)</button>
          </div>
        </section>

      </div>

      <!-- RIGHT COLUMN -->
      <div>
        <div class="card">
          <h3>Event Quick Info</h3>
          <div class="small" id="quickRules">
            <b id="evtSideTitle">COPTOTHON 2025 - Drone Competition</b>
            <div id="evtSideDates" class="small">31 Oct - 01 Nov 2025</div>
            <ul style="margin:8px 0 0 16px">
              <li>Frame ≤ 600 mm diagonal</li>
              <li>Payload ≥ 20% of mass</li>
              <li>Prop guards mandatory</li>
            </ul>
          </div>
          <div style="margin-top:12px" class="row">
            <button id="quickReg" class="ghost">Register</button>
            <button id="quickCheck" class="ghost">Check-in</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Quick Tools</h3>
          <div class="small">Utilities</div>
          <div style="margin-top:8px" class="row">
            <button id="copyPhones" class="ghost">Copy All Phones</button>
            <button id="openWhats" class="ghost">Open WhatsApp Broadcast</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Contact</h3>
          <div class="small">Event Coordinator</div>
          <div style="margin-top:8px">
            <div><b>J. Sarathkumar Sebastin</b></div>
            <div class="small">Email: sarathkumar.j@klu.ac.in</div>
            <div class="small">WhatsApp: +91 7639972833</div>
            <div style="margin-top:8px" class="row">
              <button id="msgOrganizer">Open WhatsApp</button>
            </div>
          </div>
        </div>

      </div>

    </div>

    <footer>© COPTOTHON 2025 • Live dashboard using Google Sheets • Built for KARE</footer>
  </div>

<script>
/* ==================== CONFIG ====================
   Replace SCRIPT_URL with your Apps Script Web App URL (the /exec URL)
   After deploying Apps Script, paste it below. */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwF_76qZwwBfMv62On8MgZhngW3mABzoVyTw0nsg0TUGduCdD0XYpkGsRJo6WSZ1u6KRQ/exec"; // <<<<<<<< REPLACE THIS
const ADMIN_PASS = "admin_pass_2025"; // change to your secret
const ADMIN_EMAIL = "sarathkumar.j@klu.ac.in";

/* ==================== UTIL ==================== */
const qs = sel => document.querySelector(sel);
const qsa = sel => Array.from(document.querySelectorAll(sel));
function uid(){ return 'id'+Math.random().toString(36).slice(2,9); }
function showToast(t){ alert(t); }

/* ==================== NAVIGATION ==================== */
qsa('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    qsa('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const to = btn.dataset.tab;
    qsa('[data-page]').forEach(p => p.classList.toggle('hidden', p.dataset.page !== to));
  });
});
// quick buttons
qs('#openRegisterNow').onclick = ()=> qs('.tab[data-tab="register"]').click();
qs('#openCheckinNow').onclick = ()=> qs('.tab[data-tab="checkin"]').click();
qs('#openLeaderNow').onclick = ()=> qs('.tab[data-tab="leader"]').click();
qs('#quickReg').onclick = ()=> qs('.tab[data-tab="register"]').click();
qs('#quickCheck').onclick = ()=> qs('.tab[data-tab="checkin"]').click();

/* ==================== API HELPERS ==================== */
async function apiGet(){
  try{
    const r = await fetch(SCRIPT_URL);
    return await r.json();
  }catch(e){
    console.error(e); showToast("Error loading data. Check script URL & sheet deployment.");
    return null;
  }
}
async function apiPost(action, payload) {
  try{
    const r = await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({action, payload}) });
    const txt = await r.text();
    try { return JSON.parse(txt); } catch(e){ return {raw:txt}; }
  }catch(e){
    console.error(e); showToast("Write failed: "+e.message);
    return null;
  }
}

/* ==================== STATE & RENDER ==================== */
let DB = { participants:[], announcements:[], schedule:[], attendance:[], scores:[] };

async function refreshAll(){
  const data = await apiGet();
  if(!data) return;
  DB.participants = data.participants || [];
  DB.announcements = data.announcements || [];
  DB.schedule = data.schedule || [];
  DB.attendance = data.attendance || [];
  DB.scores = data.scores || [];
  renderParticipants();
  renderAnnouncements();
  renderSchedule();
  renderLeaderboard();
  renderAttendance();
}
function renderParticipants(){
  const wrap = qs('#participantsList'); wrap.innerHTML = '';
  const arr = DB.participants.slice().reverse();
  arr.forEach(p=>{
    const div = document.createElement('div'); div.className = 'item';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><b>${p.Name || p.Name}</b><div class="small">${p.Department||''} ${p.Track?('• '+p.Track):''}</div></div>
      <div style="text-align:right">
        <button class="ghost" onclick="showQR('${p.id}','${(p.Name||'').replace(/'/g,'\\\'')}')">QR</button>
      </div></div>`;
    wrap.appendChild(div);
  });
  qs('#statParticipants').innerText = DB.participants.length;
  qs('#statChecked').innerText = DB.attendance ? DB.attendance.length : 0;
}
function renderAnnouncements(){
  const wrap = qs('#announcementsList'); wrap.innerHTML = '';
  (DB.announcements||[]).slice().reverse().forEach(a=>{
    const d=document.createElement('div'); d.className='item';
    d.innerHTML = `<b>${a.Title||a.Title}</b><div class="small">${a.Body||a.Body}</div>`;
    wrap.appendChild(d);
  });
}
function renderSchedule(){
  const wrap = qs('#scheduleList'); wrap.innerHTML = '';
  (DB.schedule||[]).slice().reverse().forEach(s=>{
    const d=document.createElement('div'); d.className='item';
    d.innerHTML = `<b>${s.Title||s.Title}</b><div class="small">${s.When||s.When}</div>`;
    wrap.appendChild(d);
  });
}
function renderLeaderboard(){
  const tb = qs('#leaderTable tbody'); tb.innerHTML = '';
  // build lookup name->score
  const rows = DB.participants.map(p=> ({ id:p.id, name:p.Name, track:p.Track, score: Number(p.Score||0) }));
  // add scores from scores sheet
  DB.scores.forEach(s=>{
    const pid = s.participantId;
    const row = rows.find(r=> r.id === pid);
    if(row) row.score += Number(s.total || 0);
  });
  rows.sort((a,b)=> (b.score||0)-(a.score||0));
  rows.forEach((r,i)=> {
    const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${r.name||''}</td><td>${r.track||''}</td><td>${r.score||0}</td>`;
    tb.appendChild(tr);
  });
}

/* attendance render */
function renderAttendance(){
  const wrap = qs('#attendanceList'); wrap.innerHTML = '';
  (DB.attendance||[]).slice().reverse().forEach(a=>{
    const p = DB.participants.find(x=> x.id === a.participantId) || {};
    const d = document.createElement('div'); d.className='item';
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><div><b>${p.Name||a.Name}</b><div class="small">${p.Phone||''}</div></div><div class="small">${a.CheckInAt||''}</div></div>`;
    wrap.appendChild(d);
  });
}

/* ==================== REGISTRATION & QR ==================== */
let lastQR = null;
qs('#btnRegisterUser').addEventListener('click', async ()=>{
  const name = qs('#rName').value.trim();
  if(!name) return showToast('Name required');
  const payload = {
    name: name,
    email: qs('#rEmail').value.trim(),
    phone: qs('#rPhone').value.trim(),
    department: qs('#rDept').value.trim(),
    track: qs('#rTrack').value.trim(),
    score: 0
  };
  const res = await apiPost('register', payload);
  if(res && res.id){
    // create QR text --> COPTOTHON|id
    const qrText = `COPTOTHON2025|${res.id}|${payload.name}`;
    lastQR = { id: res.id, name: payload.name, text: qrText };
    QRCode.toCanvas(qs('#qrCanvas'), qrText, { width:220 }, ()=>{});
    showToast('Registered. QR generated (save screenshot).');
    qs('#rName').value=''; qs('#rEmail').value=''; qs('#rPhone').value=''; qs('#rDept').value=''; qs('#rTrack').value='';
    setTimeout(refreshAll, 1200);
  } else {
    showToast('Registration failed');
  }
});
window.showQR = function(id, name){
  const p = DB.participants.find(x=> x.id === id);
  const text = `COPTOTHON2025|${id}|${p ? p.Name : name}`;
  const w = window.open('', '_blank', 'width=420,height=520');
  QRCode.toDataURL(text, { width:320 }, (err, url)=> {
    w.document.write(`<html><body style="font-family:Inter;padding:12px"><h3>${p ? p.Name : name}</h3><img src="${url}" style="width:320px"/><p><button onclick="window.print()">Print</button> <button onclick="window.close()">Close</button></p></body></html>`);
  });
};
qs('#btnDownloadQR').addEventListener('click', ()=> {
  if(!lastQR) return showToast('No QR available');
  const canvas = qs('#qrCanvas'); const url = canvas.toDataURL('image/png');
  const a = document.createElement('a'); a.href = url; a.download = `${lastQR.name}_qr.png`; a.click();
});

/* CSV import */
qs('#btnImportCSV').addEventListener('click', ()=> {
  const f = qs('#csvInput').files[0]; if(!f) return showToast('Choose CSV');
  const reader = new FileReader();
  reader.onload = async ()=> {
    const lines = reader.result.split(/\r?\n/).filter(Boolean);
    const rows = [];
    lines.forEach((ln, i)=> {
      if(i===0 && ln.toLowerCase().includes('name')) return;
      const parts = ln.split(',').map(x=> x.replace(/^"|"$/g,'').trim());
      if(parts[0]) rows.push([parts[0], parts[1]||'', parts[2]||'', parts[3]||'', parts[4]||'']);
    });
    if(rows.length===0) return showToast('No rows found');
    await apiPost('import_bulk_participants',{ rows });
    showToast('Imported '+rows.length+' participants');
    setTimeout(refreshAll, 1200);
  };
  reader.readAsText(f);
});

/* ==================== CSV EXPORTS & BACKUP ==================== */
function downloadText(text, filename, mime='text/plain'){
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([text],{type:mime})); a.download = filename; a.click();
}
qs('#downloadParticipants').addEventListener('click', ()=> {
  const rows = [["Name","Email","Phone","Department","Track","CheckIn","Score","CreatedAt"]];
  DB.participants.forEach(p=> rows.push([p.Name||'', p.Email||'', p.Phone||'', p.Department||'', p.Track||'', p.CheckIn||'', p.Score||'', p.CreatedAt||'']));
  const csv = rows.map(r=> r.map(c=> `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  downloadText(csv,'participants.csv','text/csv');
});
qs('#downloadBackup').addEventListener('click', ()=> {
  downloadText(JSON.stringify(DB,null,2),'coptothon2025_backup.json','application/json');
});

/* ==================== ANNOUNCEMENTS ==================== */
qs('#btnPostAnn').addEventListener('click', async ()=>{
  const title = qs('#aTitle').value.trim(); const body = qs('#aBody').value.trim();
  if(!title||!body) return showToast('Title & body required');
  const res = await apiPost('announce',{ title, body });
  if(res && res.id){ qs('#aTitle').value=''; qs('#aBody').value=''; if(qs('#chkWhats').checked) window.open(`https://wa.me/?text=${encodeURIComponent(title + "\\n\\n" + body)}`,'_blank'); showToast('Announcement posted'); setTimeout(refreshAll,800);}
});

/* ==================== SCHEDULE ==================== */
qs('#btnAddSchedule').addEventListener('click', async ()=>{
  const title = qs('#sTitle').value.trim(), when = qs('#sWhen').value.trim();
  if(!title||!when) return showToast('Enter title and time');
  await apiPost('announce',{ title:`SCHEDULE: ${title}`, body: when }); // quick: using announcements sheet for visibility
  qs('#sTitle').value=''; qs('#sWhen').value=''; setTimeout(refreshAll,800);
});

/* ==================== ATTENDANCE (QR SCAN) ==================== */
let stream = null, scanning=false;
const video = qs('#video');

qs('#startCamera').addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
    video.srcObject = stream; scanning = true; requestAnimationFrame(tick);
  }catch(e){ showToast('Camera access denied or unavailable'); console.error(e); }
});
qs('#stopCamera').addEventListener('click', ()=> { if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } video.srcObject=null; scanning=false; });

function tick(){
  if(!scanning) return;
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    const w = video.videoWidth, h = video.videoHeight;
    const c = document.createElement('canvas'); c.width=w; c.height=h;
    const ctx = c.getContext('2d'); ctx.drawImage(video,0,0,w,h);
    const idata = ctx.getImageData(0,0,w,h);
    const code = jsQR(idata.data, idata.width, idata.height);
    if(code){
      handleScanned(code.data);
    }
  }
  requestAnimationFrame(tick);
}
qs('#importScan').addEventListener('click', ()=> qs('#imgFile').click());
qs('#imgFile').addEventListener('change', (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const fr = new FileReader(); fr.onload = ()=> {
    const img = new Image(); img.onload = ()=> {
      const c = document.createElement('canvas'); c.width=img.width; c.height=img.height;
      const ctx = c.getContext('2d'); ctx.drawImage(img,0,0);
      const data = ctx.getImageData(0,0,c.width,c.height);
      const code = jsQR(data.data, data.width, data.height);
      if(code) handleScanned(code.data); else showToast('No QR found in image');
    }; img.src = fr.result;
  }; fr.readAsDataURL(f);
});

async function handleScanned(txt){
  // expected format: COPTOTHON2025|<id>|<name>
  const parts = String(txt).split('|');
  const id = parts[1] || parts[2] || txt;
  const p = DB.participants.find(x => x.id === id);
  if(p){
    const att = { participantId: p.id, name: p.Name, phone: p.Phone, method: "qr" };
    await apiPost('attendance', att);
    qs('#lastScanned').innerText = `Present: ${p.Name} @ ${new Date().toLocaleTimeString()}`;
    setTimeout(refreshAll,600);
  } else {
    qs('#lastScanned').innerText = `Unknown QR: ${txt}`;
  }
}

qs('#exportAttendance').addEventListener('click', async ()=>{
  const rows = [["Name","Phone","Time"]];
  DB.attendance.forEach(a=>{
    const p = DB.participants.find(x=> x.id === a.participantId) || {};
    rows.push([p.Name||a.Name||'', p.Phone||'', a.CheckInAt||'']);
  });
  const csv = rows.map(r=> r.map(c=> `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  downloadText(csv,'attendance.csv','text/csv');
});

/* ==================== ADMIN (very simple pass) ==================== */
qs('#adminLoginBtn').addEventListener('click', ()=> {
  const pass = prompt('Enter admin passphrase:');
  if(pass === ADMIN_PASS){
    localStorage.setItem('coptothon_admin', '1');
    showToast('Admin unlocked');
  } else showToast('Wrong pass');
});

qs('#clearAll').addEventListener('click', async ()=>{
  if(!localStorage.getItem('coptothon_admin')) return showToast('Admin only');
  if(!confirm('Reset all data? This deletes rows in sheets (except headers). Continue?')) return;
  await apiPost('clear_all', {});
  showToast('Database cleared'); setTimeout(refreshAll,800);
});

/* ==================== UTILS: copy phones & whatsapp ==================== */
qs('#copyPhones').addEventListener('click', async ()=>{
  const phones = DB.participants.map(p=> p.Phone).filter(Boolean);
  if(phones.length===0) return showToast('No phone numbers');
  navigator.clipboard.writeText(phones.join(',')).then(()=> showToast('Phones copied to clipboard'));
});
qs('#openWhats').addEventListener('click', ()=> {
  const msg = encodeURIComponent('COPTOTHON 2025: Important update. Please check the dashboard.');
  window.open(`https://wa.me/?text=${msg}`, '_blank');
});
qs('#msgOrganizer').addEventListener('click', ()=> {
  window.open('https://wa.me/917639972833?text='+encodeURIComponent('Hello COPTOTHON Organizer'), '_blank');
});

/* ==================== INITIAL LOAD ==================== */
(async ()=> {
  await refreshAll();
  // auto-refresh every 30s
  setInterval(refreshAll, 30000);
})();
</script>
</body>
</html>
